<html>
	<head>
		<link rel="stylesheet" href="/style/board.css" />
		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script src="http://code.jquery.com/ui/jquery-ui-git.js"></script>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io.connect();
			var printMessage = function(data) {
				var messageDiv = document.createElement('div');
				messageDiv.innerHTML = '<span style="padding-right: 15px; color: red;">' + data.user + 
					'</span>' + data.message;
				document.getElementById('chatlog').appendChild(messageDiv);
				$('#chatlog').scrollTop($('#chatlog')[0].scrollHeight);
			};

			var getSquareClass = function(x, y) {
				return x % 2 == y % 2 ? 'square_white' : 'square_black';
			};

			var selected = null;

			var move = function(socket, start_x, start_y, target_x, target_y) {
				socket.emit('move', {piece: {x: start_x, y: start_y}, position: {x:target_x, y:target_y}});
			};
			

			$(window).bind('load', function() {
				var generateSelectHandler = function(x, y, square) {
					var squareClass = getSquareClass(x, y);
					return function() {
						//printMessage({user: '*debug*', message: 'you clicked square {' + x + ',' + y + '}'});
						if (!selected) {
							selected = {x: x, y: y, square: square, squareClass: squareClass};
							$(square).removeClass(squareClass);
							$(square).addClass('selected');
							return;
						}
						move(socket, selected.x, selected.y, x, y);
						$(selected.square).removeClass('selected');
						$(selected.square).addClass(selected.squareClass);
						selected = null;

						// deselect text
						document.selection && document.selection.clear();
						window.getSelection() && window.getSelection().removeAllRanges();
					};
				};

				var SQUARE_SIZE = 70;
				var HALF_SQUARE_SIZE = 35;

				function getBoardPosition(clientX, clientY) {
					var board = $('#checkers');
					debugger;
				}

				// init board
				for(y = 7; y >= 0; --y)
				for(x = 0; x < 8; ++x)
				{
					$('#checkers')
						.first()
						.append(function() {
							var square = $('<div />')
								.addClass('square')
								.addClass(getSquareClass(x, y))
								.text('{' + x + ',' + y + '}');

							$(square).bind('click', generateSelectHandler(x, y, square));
							(function(destX, destY) {
								$(square).droppable({
									hoverClass: 'square_hover',
									drop: function( event, ui ) {
										var srcPosition = ui.draggable.context.boardPosition;
										move(socket, srcPosition.x, srcPosition.y, destX, destY);
									}
								});
							})(x, y);
							return square;
						}());

				}

				var board = $('#checkers');
				board.css('position', 'relative');
				board.css('overflow', 'auto');

				board.children('div.square').each(function(index, square) {
					square = $(square);
				});

				// receive messages
				socket.on('message', function (data) {
					printMessage(data);
					window.scrollTo(0, document.body.scrollHeight);
				});
				socket.on('user_connect', function(data) {
					var userSpan = document.createElement('div');
					userSpan.id = 'user_' + data.user;
					userSpan.innerHTML = 'Opponent: ' + data.user;
					document.getElementById('users').appendChild(userSpan);
				});
				socket.on('user_disconnect', function(data) {
					var userSpan = document.getElementById(data.user);
					if (socket.id != data.user && userSpan && userSpan.parentNode) {
						userSpan.parentNode.remove(userSpan);
					}
				});

				socket.on('board_type', function(boardType) {
					$('.board').addClass(boardType + '_board');
				});

				socket.on('num_connected_users', function(numConnectedUsers) {
					if (numConnectedUsers >= 2) {
						$('.board').first().show();
						$('#waiting').hide();
					} else {
						$('#waiting').show();
						$('.board').first().hide();
					}
				});

				socket.on('update', function(data) {
					if (!data.result) {
						logMessage({user: 'checkers', message: data.result});
					};
					
					var x = 0;
					var y = 7;
					$('#checkers')
						.children('div.square')
						.each(function(index, square) {

							square.innerHTML = data.board[x] && data.board[x][y] ? data.board[x][y].player : '';
							$(square).css('z-index', ''+(8*(7-y) + x));

							$(square).children('img').each(function(index, piece) {
								piece.boardPosition = { x: x, y: y };
								piece = $(piece);
								(function(square) {
									piece.draggable({
										containment: '#checkers',
										cursorAt: { top: HALF_SQUARE_SIZE, left: HALF_SQUARE_SIZE },
										scroll: false,
										revert: false,
										opacity: 0.6,
										helper: "clone",
										start: function() {
											square.addClass('selected');
										},
										stop: function() {
											square.removeClass('selected');
										}
									});
								})($(square));
							});

							++x;
							if (x >= 8) {
								x = 0;
								--y;
							}

						});
								
				});

				// send message functionality
				var messageInput = document.getElementById('message');
				var usernameInput = document.getElementById('username');
				var sendButton = document.getElementById('send_button');
				var sendMessage = function() {
					var message = messageInput.value;
					if (!message) {
						return;
					}
					var user = usernameInput.value || 'player';
					socket.emit('message', { user: user, message: message });
					messageInput.value = '';
					messageInput.focus();
				};

				// send messages
				$(sendButton).bind('click', sendMessage);
				$(messageInput).bind('keypress', function(evt) {
					if (evt.keyCode == 13) { sendMessage(); }
				});
			});
			
		</script>
	</head>
	<body>
		<div id="checkers" class="board"></div>
		<div id="waiting">Waiting For Opponent</div>
		<div id="users"></div>
		<div id="chatlog"></div>
		<input id="username" value="player" />
		<input id="message" />
		<input id="send_button" type="button" value="Send" \>
	</body>
</html>
