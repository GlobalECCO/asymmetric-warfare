<html>
	<head>
		<link rel="stylesheet" href="/style/board.css" />
		<!--[if IE]>
		<link rel="stylesheet" href="/style/ie.css" />
		<![endif]-->
		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script src="http://code.jquery.com/ui/jquery-ui-git.js"></script>
		<!--[if lt IE 9]>
		<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
		<![endif]-->

		<script src="/socket.io/socket.io.js"></script>
		<script>

			if (Array.prototype.forEach === undefined) {
				Array.prototype.forEach = function(callback) {
					for (var idx = 0; idx < this.length; ++idx) {
						callback(this[idx]);
					}
				}
			}

			var socket = io.connect();
			var g_boardType = 'guerilla';
			var printMessage = function(data) {
				var messageDiv = document.createElement('div');
				messageDiv.innerHTML = '<span style="padding-right: 15px; color: red;">' + data.user + 
					'</span>' + data.message;
				document.getElementById('chatlog').appendChild(messageDiv);
				$('#chatlog').scrollTop($('#chatlog')[0].scrollHeight);
			};

			var getSquareClass = function(x, y) {
				return x % 2 == y % 2 ? 'square_white' : 'square_black';
			};

			var selected = null;

			var move = function(socket, start_x, start_y, target_x, target_y) {
				socket.emit('move', {piece: {x: start_x, y: start_y}, position: {x:target_x, y:target_y}});
			};
			

			$(window).bind('load', function() {
				var generateSelectHandler = function(x, y, square) {
					var squareClass = getSquareClass(x, y);
					return function() {
						//printMessage({user: '*debug*', message: 'you clicked square {' + x + ',' + y + '}'});
						if (!selected) {
							selected = {x: x, y: y, square: square, squareClass: squareClass};
							$(square).removeClass(squareClass);
							$(square).addClass('selected');
							return;
						}
						move(socket, selected.x, selected.y, x, y);
						$(selected.square).removeClass('selected');
						$(selected.square).addClass(selected.squareClass);
						selected = null;

						// deselect text
						document.selection && document.selection.clear();
						window.getSelection() && window.getSelection().removeAllRanges();
					};
				};

				var SQUARE_SIZE = 70;
				var HALF_SQUARE_SIZE = 35;

				// allow direct querying of board squares by x/y
				var g_boardSquares = {};
				function getSquare(x, y) {
					return g_boardSquares[x + ',' + y];
				}
				function setSquare(x, y, square) {
					g_boardSquares[x + ',' + y] = square;
				}

				// init board
				for(y = 7; y >= 0; --y)
				for(x = 0; x < 8; ++x)
				{
					$('#checkers')
						.first()
						.append(function() {
							var square = $('<div />')
								.addClass('square')
								.addClass(getSquareClass(x, y))
								.text('{' + x + ',' + y + '}')
								.css('z-index', ''+(8*(7-y) + x));

							setSquare(x, y, square);

							$(square).bind('click', generateSelectHandler(x, y, square));
							(function(destX, destY) {
								$(square).droppable({
									hoverClass: 'square_hover',
									drop: function( event, ui ) {
										var srcPosition = ui.draggable.context.boardPosition;
										move(socket, srcPosition.x, srcPosition.y, destX, destY);
									}
								});
							})(x, y);
							return square;
						}());

				}

				var board = $('#checkers');
				board.css('position', 'relative');
				board.css('overflow', 'hidden');

				board.children('div.square').each(function(index, square) {
					square = $(square);
				});

				// receive messages
				socket.on('message', function (data) {
					printMessage(data);
					window.scrollTo(0, document.body.scrollHeight);
				});
				socket.on('user_connect', function(data) {
					var userSpan = document.createElement('div');
					userSpan.id = 'user_' + data.user;
					userSpan.innerHTML = 'Opponent: ' + data.user;
					document.getElementById('users').appendChild(userSpan);
				});
				socket.on('user_disconnect', function(data) {
					var userSpan = document.getElementById(data.user);
					if (socket.id != data.user && userSpan && userSpan.parentNode) {
						userSpan.parentNode.remove(userSpan);
					}
				});

				socket.on('board_type', function(boardType) {
					g_boardType = boardType;
					$('.board').addClass(g_boardType + '_board');
				});

				socket.on('num_connected_users', function(numConnectedUsers) {
					if (numConnectedUsers >= 2) {
						$('.board').first().show();
						$('#waiting').hide();
					} else {
						$('#waiting').show();
						$('.board').first().hide();
					}
				});

				socket.on('update', function(updateResponse) {
					if (!updateResponse || !updateResponse.board) {
						return;
					}

					var gameState = updateResponse.board;

					// clear board state
					for (var y = 7; y >= 0; --y) {
						for (var x = 0; x < 8; ++x) {
							var square = getSquare(x, y);
							$(square).text('');
						}
					}

					// TODO: load guerilla pieces

					// load soldier pieces
					var soldierPieces = gameState.arrSoldierPieces || [];
					soldierPieces.forEach(function(soldierPiece) {
						if (!soldierPiece || !soldierPiece.position) {
							return;
						}
						var position = soldierPiece.position;
						var square = getSquare(position.x, position.y);
						if (!square) {
							return;
						}
						square = $(square);
						square.html('<img src="images/' + g_boardType + '/soldier_piece.png" class="piece" width=68 height=68 alt="white" />');
						square.children('img').each(function(index, pieceImage) {
							pieceImage.boardPosition = position;
							$(pieceImage).draggable({
								containment: '#checkers',
								cursorAt: { top: HALF_SQUARE_SIZE, left: HALF_SQUARE_SIZE },
								scroll: false,
								revert: false,
								opacity: 0.6,
								helper: "clone",
								start: function() {
									square.addClass('selected');
								},
								stop: function() {
									square.removeClass('selected');
								}
							});
						});
					});

				});

				// send message functionality
				var messageInput = document.getElementById('message');
				var usernameInput = document.getElementById('username');
				var sendButton = document.getElementById('send_button');
				var sendMessage = function() {
					var message = messageInput.value;
					if (!message) {
						return;
					}
					var user = usernameInput.value || 'player';
					socket.emit('message', { user: user, message: message });
					messageInput.value = '';
					messageInput.focus();
				};

				// send messages
				$(sendButton).bind('click', sendMessage);
				$(messageInput).bind('keypress', function(evt) {
					if (evt.keyCode == 13) { sendMessage(); }
				});
			});
			
		</script>
	</head>
	<body>
		<div id="checkers" class="board"></div>
		<div id="waiting">Waiting For Opponent</div>
		<div id="users"></div>
		<div id="chatlog"></div>
		<input id="username" value="player" />
		<input id="message" />
		<input id="send_button" type="button" value="Send" \>
	</body>
</html>
